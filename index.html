<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FMS Delivered Orders Audit</title>

<style>
:root{
  --bg:#0a0c10;--card:#0f1420;--text:#e6edf6;--muted:#93a4b7;
  --accent:#7c3aed;--accent2:#22d3ee;--border:#1f2a3a;
  --ok:#10b981
}
*{box-sizing:border-box}
body{
  margin:0;
  background:radial-gradient(1200px 900px at 10% -10%, #121a2b 0%, transparent 60%), var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif
}
.wrap{max-width:1100px;margin:40px auto;padding:0 16px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:18px;
  margin-bottom:16px
}
input{
  width:100%;
  padding:12px;
  border-radius:14px;
  background:#0b0f19;
  border:1px solid var(--border);
  color:var(--text)
}
button{
  margin-top:10px;
  padding:10px 16px;
  border-radius:14px;
  border:1px solid var(--border);
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  font-weight:700;
  cursor:pointer
}
.list{margin-top:10px}
.item{
  padding:10px;
  border-radius:12px;
  background:#0b0f19;
  border:1px solid var(--border);
  margin-bottom:6px;
  cursor:pointer
}
.item:hover{background:#141b2e}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:12px;
}
.order-card{
  background:#0b0f19;
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px
}
.badge{
  display:inline-block;
  padding:4px 8px;
  border-radius:999px;
  font-size:11px;
  background:rgba(16,185,129,.15);
  color:var(--ok);
  margin-bottom:6px
}
.muted{color:var(--muted);font-size:12px}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center
}
.timer{
  margin-top:8px;
  font-size:12px;
  color:var(--muted)
}
.progress-wrap{
  margin-top:10px
}
.progress-bar{
  width:100%;
  height:10px;
  background:#0b0f19;
  border:1px solid var(--border);
  border-radius:999px;
  overflow:hidden
}
.progress-fill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  transition:width .2s ease
}
.progress-text{
  margin-top:4px;
  font-size:12px;
  color:var(--muted)
}
</style>
</head>

<body>
<div class="wrap">
  <h1>FMS Delivered Orders Audit</h1>
  <div class="muted">Delivered orders by Bill-To (missing BOL only)</div>

  <div class="card">
    <label>Bill To</label>
    <input id="billToInput" placeholder="Type 3+ characters"/>
    <div id="billList" class="list"></div>
    <button id="searchBtn" disabled>Search</button>
    <div id="authStatus" class="muted">Authenticating…</div>

    <div id="timer" class="timer" style="display:none">Elapsed Time: 00:00</div>

    <div id="progressWrap" class="progress-wrap" style="display:none">
      <div class="progress-bar">
        <div id="progressFill" class="progress-fill"></div>
      </div>
      <div id="progressText" class="progress-text">Checked 0 / 0</div>
    </div>
  </div>

  <div class="card" id="summaryCard" style="display:none">
    <div class="header">
      <strong id="summaryTitle"></strong>
      <div>Total Missing BOL: <span id="totalCount">0</span></div>
    </div>
  </div>

  <div class="grid" id="results"></div>
</div>

<script>
(() => {

const BASE="https://fms.item.com";
const LOGIN_URL=`${BASE}/fms-platform-user/Auth/Login`;
const BILLTO_URL=`${BASE}/fms-platform-order/shipment-orders/search-business-client`;
const QUERY_URL=`${BASE}/fms-platform-order/shipment-orders/query`;
const FILES_URL=`${BASE}/fms-platform-order/files`;

const USER="cmosqueda";
const PASS="cam2121";
const FMS_CLIENT="FMS_WEB";
const COMPANY_ID="SBFH";

let FMS_TOKEN=null;
let AUTH_TOKEN=null;
let debounce=null;
let selectedBillTo=null;
let timerInterval=null;
let startTime=null;

let totalOrders=0;
let checkedOrders=0;

const $=id=>document.getElementById(id);

/* ---------- AUTH ---------- */
async function login(){
  const r=await fetch(LOGIN_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json","fms-client":FMS_CLIENT },
    body:JSON.stringify({account:USER,password:PASS})
  });
  const j=await r.json();
  FMS_TOKEN=j?.data?.token;
  AUTH_TOKEN=j?.data?.third_party_token;
  $("authStatus").textContent="Authenticated";
}

/* ---------- BILL TO SEARCH ---------- */
async function billToSearch(q){
  const r=await fetch(`${BILLTO_URL}?Code=${encodeURIComponent(q)}`,{
    headers:{
      "fms-client":FMS_CLIENT,
      "fms-token":FMS_TOKEN,
      "authorization":AUTH_TOKEN,
      "company-id":COMPANY_ID
    }
  });
  return r.json();
}

/* ---------- BOL CHECK ---------- */
async function hasBOL(orderNo){
  try{
    const r=await fetch(`${FILES_URL}/${orderNo}`,{
      headers:{
        "fms-client":FMS_CLIENT,
        "fms-token":FMS_TOKEN,
        "authorization":AUTH_TOKEN,
        "company-id":COMPANY_ID
      }
    });
    const j=await r.json();
    return (j?.data||[]).some(f=>f.file_type==="BOL");
  }catch{
    return false;
  }
}

/* ---------- BATCH ---------- */
async function processInBatches(items,batchSize,handler){
  for(let i=0;i<items.length;i+=batchSize){
    await Promise.all(items.slice(i,i+batchSize).map(handler));
  }
}

/* ---------- TIMER ---------- */
function startTimer(){
  startTime=Date.now();
  $("timer").style.display="block";
  timerInterval=setInterval(()=>{
    const e=Math.floor((Date.now()-startTime)/1000);
    $("timer").textContent=`Elapsed Time: ${String(Math.floor(e/60)).padStart(2,"0")}:${String(e%60).padStart(2,"0")}`;
  },1000);
}
function stopTimer(){ clearInterval(timerInterval); }

/* ---------- PROGRESS ---------- */
function updateProgress(){
  const pct = totalOrders ? (checkedOrders/totalOrders)*100 : 0;
  $("progressFill").style.width = `${pct}%`;
  $("progressText").textContent = `Checked ${checkedOrders} / ${totalOrders}`;
}

/* ---------- SEARCH ---------- */
async function runSearch(){
  if(!selectedBillTo) return;

  $("results").innerHTML="";
  $("summaryCard").style.display="none";
  $("progressWrap").style.display="block";

  checkedOrders=0;
  updateProgress();
  startTimer();

  const r=await fetch(QUERY_URL,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "fms-client":FMS_CLIENT,
      "fms-token":FMS_TOKEN,
      "authorization":AUTH_TOKEN,
      "company-id":COMPANY_ID
    },
    body:JSON.stringify({
      bill_to_accounts:[selectedBillTo.code],
      status:["43","44","50"],
      record_status:"0",
      page_number:1,
      page_size:10000
    })
  });

  const items=(await r.json())?.data?.items||[];
  totalOrders=items.length;
  updateProgress();

  let missingBolCount=0;

  await processInBatches(items,15,async o=>{
    const bolExists=await hasBOL(o.order_no);

    checkedOrders++;
    updateProgress();

    if(bolExists) return;

    missingBolCount++;

    const d=document.createElement("div");
    d.className="order-card";
    d.innerHTML=`
      <div class="badge">Delivered</div>
      <div><strong>PRO:</strong> ${o.tracking_no}</div>
      <div><strong>DO:</strong> ${o.order_no}</div>
      <div><strong>PU:</strong> ${o.reference5||"—"}</div>
      <div class="muted">Pickup Complete: ${o.pickup_complete_date||"—"}</div>
      <div class="muted">Delivered Date: ${o.delivery_date||"—"}</div>
      <div class="muted">BOL Attached: <strong>NO</strong></div>
    `;
    $("results").appendChild(d);
  });

  stopTimer();

  $("summaryTitle").textContent=`Bill To: ${selectedBillTo.name} (${selectedBillTo.code})`;
  $("totalCount").textContent=missingBolCount;
  $("summaryCard").style.display="block";
}

/* ---------- INPUT ---------- */
$("billToInput").addEventListener("input",e=>{
  const q=e.target.value.trim();
  $("billList").innerHTML="";
  $("searchBtn").disabled=true;
  selectedBillTo=null;
  if(q.length<3) return;

  clearTimeout(debounce);
  debounce=setTimeout(async()=>{
    (await billToSearch(q))?.data?.items?.forEach(i=>{
      const d=document.createElement("div");
      d.className="item";
      d.textContent=`${i.print_name} (${i.code})`;
      d.onclick=()=>{
        $("billToInput").value=i.code;
        $("billList").innerHTML="";
        selectedBillTo={code:i.code,name:i.print_name};
        $("searchBtn").disabled=false;
      };
      $("billList").appendChild(d);
    });
  },300);
});

$("searchBtn").addEventListener("click",runSearch);

login();

})();
</script>
</body>
</html>
