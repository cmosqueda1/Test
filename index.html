<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>FMS Delivered Orders Audit</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<style>
:root{
  --bg:#05070b;
  --card:#0f1420;
  --card-soft:#111827;
  --text:#e6edf6;
  --muted:#93a4b7;
  --accent:#7c3aed;
  --border:#1f2933;
  --ok:#10b981;
}

*{box-sizing:border-box}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
}

.wrap{
  max-width:1100px;
  margin:40px auto;
  padding:20px;
}

h1{margin-bottom:16px}

.card{
  background:linear-gradient(180deg,#111827 0%, #0b1220 100%);
  border:1px solid var(--border);
  border-radius:16px;
  padding:18px;
  margin-bottom:16px;
}

input,button{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#020617;
  color:var(--text);
}

button{
  margin-top:10px;
  background:linear-gradient(135deg,var(--accent),#4c1d95);
  border:none;
  cursor:pointer;
}

.bill-results{
  margin-top:10px;
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
}

.bill-item{
  padding:10px 14px;
  cursor:pointer;
  border-bottom:1px solid var(--border);
}

.bill-item:hover{
  background:#020617;
}

.bill-item:last-child{border-bottom:none}

.badge{
  display:inline-block;
  padding:6px 12px;
  border-radius:999px;
  border:1px solid var(--border);
  margin-right:8px;
}

.results{
  font-family:ui-monospace,Consolas,monospace;
  font-size:13px;
  white-space:pre-wrap;
}
</style>
</head>

<body>
<div class="wrap">
<h1>FMS Delivered Orders Audit</h1>

<div class="card">
  <label>Bill To</label>
  <input id="billInput" placeholder="Type at least 3 characters…" oninput="billTypeAhead()"/>
  <div id="billResults" class="bill-results"></div>
</div>

<div class="card">
  <button onclick="searchOrders()">Search Delivered Orders</button>
</div>

<div class="card" id="summary"></div>
<div class="card">
  <div class="results" id="output"></div>
</div>
</div>

<script>
const FMS_BASE = "https://fms.item.com";
let token = null;
let selectedBill = null;

/* =====================
   LOGIN (FIXED)
===================== */
async function login(){
  if(token) return token;

  const res = await fetch(`${FMS_BASE}/fms-platform-user/Auth/Login`,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "fms-client":"FMS_WEB",
      "company-id":"SBFH"
    },
    body:JSON.stringify({
      account:"cmosqueda",
      password:"cam2121"
    })
  });

  const json = await res.json();
  token = json.data.token;
  return token;
}

/* =====================
   BILL TO TYPEAHEAD
===================== */
async function billTypeAhead(){
  const q = document.getElementById("billInput").value.trim();
  if(q.length < 3) return document.getElementById("billResults").innerHTML = "";

  await login();

  const res = await fetch(
    `${FMS_BASE}/fms-platform-order/shipment-orders/search-business-client?Code=${encodeURIComponent(q)}`,
    {
      headers:{
        "Authorization": token,
        "fms-token": token,
        "fms-client":"FMS_WEB",
        "company-id":"SBFH"
      }
    }
  );

  const json = await res.json();
  const wrap = document.getElementById("billResults");
  wrap.innerHTML = "";

  json.data.items.forEach(b=>{
    const div = document.createElement("div");
    div.className = "bill-item";
    div.textContent = `${b.print_name} (${b.code})`;
    div.onclick = ()=>{
      selectedBill = b;
      document.getElementById("billInput").value = b.print_name;
      wrap.innerHTML = "";
    };
    wrap.appendChild(div);
  });
}

/* =====================
   ORDER SEARCH
===================== */
async function searchOrders(){
  if(!selectedBill) return alert("Select a Bill To");

  await login();

  const payload = {
    bill_to_accounts:[selectedBill.code],
    status:["43","44","50"],
    page_number:1,
    page_size:10000,
    record_status:"0"
  };

  const res = await fetch(
    `${FMS_BASE}/fms-platform-order/shipment-orders/query`,
    {
      method:"POST",
      headers:{
        "Authorization": token,
        "fms-token": token,
        "Content-Type":"application/json",
        "fms-client":"FMS_WEB",
        "company-id":"SBFH"
      },
      body:JSON.stringify(payload)
    }
  );

  const json = await res.json();
  const pros = [...new Set(json.data.items.map(o=>o.tracking_no).filter(Boolean))];

  document.getElementById("summary").innerHTML = `
    <span class="badge">${selectedBill.print_name}</span>
    <span class="badge">Delivered Orders: ${pros.length}</span>
  `;

  document.getElementById("output").textContent =
    pros.map(p=>`PRO ${p} — Delivered`).join("\n");
}
</script>
</body>
</html>
