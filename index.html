<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FMS Delivered Orders Audit</title>

<style>
:root{
  --bg:#0a0c10;--card:#0f1420;--text:#e6edf6;--muted:#93a4b7;
  --accent:#7c3aed;--accent2:#22d3ee;--border:#1f2a3a
}
*{box-sizing:border-box}
body{
  margin:0;
  background:radial-gradient(1200px 900px at 10% -10%, #121a2b 0%, transparent 60%), var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif
}
.wrap{max-width:980px;margin:40px auto;padding:0 16px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:18px;
  margin-bottom:16px
}
input{
  width:100%;
  padding:12px;
  border-radius:14px;
  background:#0b0f19;
  border:1px solid var(--border);
  color:var(--text)
}
.list{margin-top:10px}
.item{
  padding:10px;
  border-radius:12px;
  background:#0b0f19;
  border:1px solid var(--border);
  margin-bottom:6px;
  cursor:pointer
}
.item:hover{background:#141b2e}
pre{
  background:#0b0f19;
  border-radius:14px;
  padding:12px;
  border:1px solid var(--border)
}
.muted{color:var(--muted);font-size:12px}
.status{margin-top:8px;font-size:12px;color:var(--muted)}
</style>
</head>

<body>
<div class="wrap">
  <h1>FMS Delivered Orders Audit</h1>
  <div class="muted">Bill-To lookup (pre-authenticated)</div>

  <div class="card">
    <label>Bill To</label>
    <input id="billToInput" placeholder="Type 3+ characters"/>
    <div id="billList" class="list"></div>
    <div id="loginStatus" class="status">Authenticatingâ€¦</div>
  </div>

  <div class="card">
    <strong>Output</strong>
    <pre id="output"></pre>
  </div>
</div>

<script>
(() => {

const BASE = "https://fms.item.com";
const LOGIN_URL = `${BASE}/fms-platform-user/Auth/Login`;
const BILLTO_URL = `${BASE}/fms-platform-order/shipment-orders/search-business-client`;

const USER = "cmosqueda";
const PASS = "cam2121";
const FMS_CLIENT = "FMS_WEB";
const COMPANY_ID = "SBFH";

let FMS_TOKEN = null;
let AUTH_TOKEN = null;
let debounce = null;

const $ = id => document.getElementById(id);
const out = $("output");
const statusEl = $("loginStatus");

/* -----------------------------------
   LOGIN (runs immediately on load)
----------------------------------- */
async function login(){
  const r = await fetch(LOGIN_URL,{
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "fms-client":FMS_CLIENT
    },
    body:JSON.stringify({
      account:USER,
      password:PASS
    })
  });

  const j = await r.json();
  if(!j?.data?.token) throw new Error("Login failed");

  FMS_TOKEN = j.data.token;
  AUTH_TOKEN = j.data.third_party_token;

  statusEl.textContent = "Authenticated";
}

/* -----------------------------------
   BILL-TO SEARCH (GET, token-based)
----------------------------------- */
async function billToSearch(q){
  const r = await fetch(`${BILLTO_URL}?Code=${encodeURIComponent(q)}`,{
    method:"GET",
    headers:{
      "accept":"application/json",
      "fms-client":FMS_CLIENT,
      "fms-token":FMS_TOKEN,
      "authorization":AUTH_TOKEN,
      "company-id":COMPANY_ID
    }
  });

  return r.json();
}

/* -----------------------------------
   INPUT HANDLER
----------------------------------- */
$("billToInput").addEventListener("input",e=>{
  const q = e.target.value.trim();
  $("billList").innerHTML="";
  out.textContent="";
  if(q.length < 3) return;

  clearTimeout(debounce);
  debounce = setTimeout(async()=>{
    try{
      const j = await billToSearch(q);
      const items = j?.data?.items || [];

      items.forEach(i=>{
        const d = document.createElement("div");
        d.className = "item";
        d.textContent = `${i.print_name} (${i.code})`;
        d.onclick = ()=>{
          $("billToInput").value = i.code;
          $("billList").innerHTML="";
          out.textContent = JSON.stringify(i,null,2);
        };
        $("billList").appendChild(d);
      });

      if(!items.length){
        out.textContent = "No Bill To results found.";
      }
    }catch(err){
      out.textContent = "Bill To search failed";
    }
  },300);
});

/* -----------------------------------
   INIT
----------------------------------- */
login().catch(e=>{
  statusEl.textContent = "Authentication failed";
  out.textContent = e.message;
});

})();
</script>
</body>
</html>
